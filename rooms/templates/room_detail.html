{% extends 'base.html' %}

{% block title %}{{ room.room_type }} | The Grand Retreat{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Messages -->
  {% if messages %}
    <div class="mt-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row">
    <div class="col-md-6">
      <img src="{{ room.image.url }}" alt="{{ room.room_type }}" class="img-fluid rounded" style="width: 100%;">
    </div>
    <div class="col-md-6">
      <h2 class="fw-bold">{{ room.room_type }}</h2>
      <p class="text-muted">{{ room.description }}</p>
      <p><strong>Price:</strong> ₹{{ room.price_per_night }} / night</p>
      <p><strong>Room Number:</strong> {{ room.room_number }}</p>

      {% if room.is_available %}
        <span class="badge bg-success mb-2">Available</span>
        <button class="btn btn-gold w-100 book-btn" data-bs-toggle="modal" data-bs-target="#bookingModal"
          data-room="{{ room.id }}" data-room-number="{{ room.room_number }}" data-price="{{ room.price_per_night }}">
          Book Now
        </button>
      {% else %}
        <span class="badge bg-danger">Booked</span>
        <button class="btn btn-secondary w-100" disabled>Unavailable</button>
      {% endif %}
    </div>
  </div>

  <!-- Booking Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="bookingModalLabel">Book Your Room</h5>
          <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form method="POST" action="">
            {% csrf_token %}
            <input type="hidden" name="room" id="room_id" />

            <div class="mb-3">
              <label class="form-label">Room Number</label>
              <input type="text" id="room_number_display" class="form-control" readonly />
            </div>

            <div class="row mb-3">
              <div class="col">
                <label class="form-label">Check-in</label>
                <input type="date" name="check_in" class="form-control" required min="{{ today }}">
              </div>
              <div class="col">
                <label class="form-label">Check-out</label>
                <input type="date" name="check_out" class="form-control" required min="{{ today }}">
              </div>
            </div>

            <div id="priceEstimate" class="text-end text-muted mb-2" style="display:none;">
              Estimated Price: ₹<span id="estimatedPrice">0</span>
            </div>

            <button type="submit" class="btn btn-gold w-100">Confirm Booking</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for dynamic room data and price estimation -->
<script>
  document.querySelectorAll('.book-btn').forEach(button => {
    button.addEventListener('click', function () {
      const roomId = this.dataset.room;
      const roomNumber = this.dataset.roomNumber;
      const price = this.dataset.price;

      document.getElementById('room_id').value = roomId;
      document.getElementById('room_id').setAttribute('data-price', price);
      document.getElementById('room_number_display').value = roomNumber;

      document.getElementById('estimatedPrice').textContent = '0';
      document.getElementById('priceEstimate').style.display = 'none';
    });
  });

  const checkInInput = document.querySelector('input[name="check_in"]');
  const checkOutInput = document.querySelector('input[name="check_out"]');
  const priceEstimateContainer = document.getElementById('priceEstimate');
  const estimatedPriceElement = document.getElementById('estimatedPrice');
  const roomIdInput = document.getElementById('room_id');

  [checkInInput, checkOutInput].forEach(input => {
    input.addEventListener('change', function () {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);
      const price = parseFloat(roomIdInput.getAttribute('data-price'));

      if (checkIn && checkOut && checkOut > checkIn && price) {
        const nights = Math.floor((checkOut - checkIn) / (1000 * 60 * 60 * 24));
        const total = nights * price;
        estimatedPriceElement.textContent = total;
        priceEstimateContainer.style.display = 'block';
      } else {
        priceEstimateContainer.style.display = 'none';
      }
    });
  });
</script>
{% endblock %}
